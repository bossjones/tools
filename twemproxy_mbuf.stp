# show mbuf usage
# @ton31337

global mbuf_size;
global mbuf_max;

function print_head()
{
        ansi_clear_screen();
        printf("Probing...Type CTRL+C to stop probing.\n");
}

# Return the length of data in mbuf.
probe process("/usr/local/bin/nutcracker").function("mbuf_length").return
{
        mbuf_size[$return]++;
}

# Return the remaining space size for any new data in mbuf.
probe process("/usr/local/bin/nutcracker").function("mbuf_size").return
{
        mbuf_max = ($return > mbuf_max) ? $return : mbuf_max;
}

probe timer.s(1)
{
        print_head();
        printf("Mbuf_size\tMbuf_free\tCount\n");
        foreach(m in mbuf_size- limit 8) {
                printf("%d\t\t%d\t\t%d\n", m, (mbuf_max - m), mbuf_size[m]);
        }

        delete mbuf_size;
}
